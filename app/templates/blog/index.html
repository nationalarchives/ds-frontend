{% extends 'base.html' %}

{%- from 'components/button/macro.html' import tnaButton -%}
{%- from 'components/card/macro.html' import tnaCard -%}
{%- from 'components/pagination/macro.html' import tnaPagination -%}
{%- from 'components/quick-filters/macro.html' import tnaQuickFilters -%}
{%- from 'macros/global_alert_banners.html' import global_alert_banners -%}
{%- from 'macros/meta.html' import meta -%}
{%- from 'macros/wagtail_blocks/featured_page.html' import wagtailFeaturedPage -%}

{%- set themeAccent = 'black' if page_data.mourning_notice else 'orange' -%}
{%- set pageTitle = page_data.title -%}
{%- if year %}
  {%- if month_name %}
    {%- set pageTitle = pageTitle + ' - ' + month_name + ' ' + (year | string) -%}
    {%- else %}
    {%- set pageTitle = pageTitle + ' - ' + (year | string) -%}
  {%- endif %}
{%- endif %}

{% block head %}
{{ super() }}
{{ meta(page_data) }}
    {% if 'page' in request.args %}
    <!-- TODO: Escape? -->
    <link rel="canonical" href="{{ request.url }}">
    {% elif (request.args | length) %}
    <link rel="canonical" href="{{ request.url }}&page={{ page }}">
    {% else %}
    <link rel="canonical" href="{{ request.url }}?page={{ page }}">
    {% endif %}
    {%- if page_data.meta.type == 'blog.BlogIndexPage' %}
    <link rel="alternate" type="application/rss+xml" href="{{ url_for('feeds.rss_all_feed') }}" title="The National Archives RSS feed">
    <link rel="alternate" type="application/atom+xml" href="{{ url_for('feeds.rss_all_feed', format='atom') }}" title="The National Archives Atom feed">
    {%- elif page_data.meta.type == 'blog.BlogPage' %}
    <link rel="alternate" type="application/rss+xml" href="{{ url_for('feeds.rss_feed', blog_id=page_data.id) }}" title="{{ page_data.title }} RSS feed">
    <link rel="alternate" type="application/atom+xml" href="{{ url_for('feeds.rss_feed', blog_id=page_data.id, format='atom') }}" title="{{ page_data.title }} Atom feed">
    {%- endif %}
{% endblock %}

{% block stylesheets %}
{{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='blog.css', v=app_config.BUILD_VERSION) }}" media="screen,print">
{% endblock %}

{% block main %}
  {% block beforeContent %}
  {%- if breadcrumbs and breadcrumbs | length > 0 %}
    <div class="tna-background-accent-light">
      <div class="tna-container">
        <div class="tna-column tna-column--full">
          {{ tnaBreadcrumbs({
            'items': breadcrumbs,
            'structuredData': True,
            'classes': 'tna-!--padding-vertical-s'
          }) }}
        </div>
      </div>
    </div>
  {%- endif %}
  {% endblock %}
  <main class="tna-main {{ mainClasses }}" id="main-content">
    {%- if page_data.global_alert or page_data.mourning_notice %}
    <div class="tna-background-accent-light">
      {{ global_alert_banners(page_data.global_alert, page_data.mourning_notice) }}
    </div>
    {%- endif %}
    <div class="tna-background-accent-light tna-!--padding-top-m tna-section">
      <div class="tna-container">
        <div class="tna-column tna-column--width-2-3 tna-column--width-5-6-medium tna-column--full-small tna-column--full-tiny">
          {%- if blogs and page_data.meta.type == 'blog.BlogIndexPage' %}
          <h1 class="tna-heading-xl">{{ pageTitle }}</h1>
          {%- else %}
          <hgroup class="tna-hgroup-xl">
            <p class="tna-hgroup__supertitle">Blog</p>
            <h1 class="tna-hgroup__title">{{ pageTitle }}</h1>
          </hgroup>
          {%- endif %}
          {%- if page_data.intro %}
          <div class="tna-large-paragraph tna-!--margin-top-s">
            {{ page_data.intro | tna_html | safe }}
          </div>
          {%- endif %}
        </div>
      </div>
    </div>
    {%- if page == 1 and blog_posts %}
    <div class="etna-background-accent-light-half">
      <div class="tna-container">
        <div class="tna-column tna-column--full">
          {% set featured_card_content = {
            'supertitle-': 'TODO: Parent',
            'title': blog_posts[0].title,
            'headingLevel': 2,
            'headingSize': 'l',
            'href': blog_posts[0].full_url,
            'label': 'New' if blog_posts[0].is_newly_published,
            'labelColour': 'green',
            'meta': [
              {
                'title': 'Published',
                'text':  blog_posts[0].published_date.value | pretty_date
              }
            ],
            'body': blog_posts[0].teaser_text | tna_html | safe,
            'fullAreaClick': True,
            'horizontal': True,
            'horizontalFlipped': True,
            'style': 'contrast'
          } %}
          {%- if blog_posts[0].teaser_image %}
            {% set featured_card_content = dict(featured_card_content, **{
              'lazyImage': True,
              'imageSrc': blog_posts[0].teaser_image.jpeg.full_url,
              'imageAlt': blog_posts[0].teaser_image.alt_text or '',
              'imageWidth': blog_posts[0].teaser_image.jpeg.width,
              'imageHeight': blog_posts[0].teaser_image.jpeg.height,
              'imageSources': [
                {
                  'src': blog_posts[0].teaser_image.webp.full_url,
                  'type': 'image/webp',
                  'width': blog_posts[0].teaser_image.webp.width,
                  'height': blog_posts[0].teaser_image.webp.height
                }
              ]
            }) %}
          {%- endif %}
          {{ tnaCard(featured_card_content) }}
        </div>
      </div>
    </div>
    {%- endif %}
    <div class="tna-container">
      <div class="tna-column tna-column--width-3-4 tna-column--width-2-3-medium tna-column--full-small tna-column--full-tiny tna-!--padding-top-m tna-column--order-1">
        <div class="tna-container tna-container--nested">
          <div class="tna-column tna-column--full">
            {%- if page > 1 %}
            <h2 class="tna-heading-l">Blog posts, page {{ page }} of {{ pages }}</h2>
            {%- else %}
            <h2 class="tna-heading-l">Most recent posts</h2>
            {%- endif %}
            <ul class="tna-container tna-container--nested">
              {% for blog_post in blog_posts %}
              {% if page > 1 or loop.index > 1 %}
              <li class="tna-column tna-column--width-1-3 tna-column--width-1-2-medium tna-column--width-1-2-small tna-column--full-tiny tna-!--margin-top-m tna-!--margin-bottom-l">
                {% set card_content = {
                  'supertitle-': blog_post.type_label,
                  'title': blog_post.title,
                  'headingLevel': 3,
                  'headingSize': 's',
                  'href': blog_post.full_url,
                  'body': blog_post.teaser_text,
                  'label': 'New' if blog_post.is_newly_published,
                  'labelColour': 'green',
                  'meta': [
                    {
                      'title': 'Published',
                      'text':  blog_post.published_date.value | pretty_date
                    }
                  ],
                  'fullAreaClick': True,
                  'classes': 'tna-card--full-height'
                } %}
                {%- if blog_post.teaser_image %}
                  {% set card_content = dict(card_content, **{
                    'imageSrc': blog_post.teaser_image.jpeg.full_url,
                    'imageAlt': blog_post.teaser_image.alt_text or '',
                    'imageWidth': blog_post.teaser_image.jpeg.width,
                    'imageHeight': blog_post.teaser_image.jpeg.height,
                    'imageSources': [
                      {
                        'src': blog_post.teaser_image.webp.full_url,
                        'type': 'image/webp',
                        'width': blog_post.teaser_image.webp.width,
                        'height': blog_post.teaser_image.webp.height
                      }
                    ]
                  }) %}
                {%- endif %}
                {{ tnaCard(card_content) }}
              </li>
              {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% if pages > 1 %}
      <div class="tna-column tna-column--full tna-!--margin-top-l tna-column--order-4 tna-column--order-2-small tna-column--order-2-tiny">
        {{ tnaPagination(pagination) }}
      </div>
      {% endif %}
      <div class="tna-column tna-column--width-1-4 tna-column--width-1-3-medium tna-column--full-small tna-column--full-tiny tna-!--padding-top-m tna-column--order-3">
        <div class="tna-aside tna-aside--tight tna-background-tint">
          {%- if blogs and page_data.meta.type == 'blog.BlogIndexPage' %}
          <h2 class="tna-heading-m">All blogs</h2>
          {% set blogs_list = [] %}
          {% for blog in blogs %}
            {% set blogs_list = blogs_list.append({
              'label': blog.title + ' (' + (blog.posts | string) + ')' if blog.posts else blog.title,
              'href': blog.full_url,
              'title': blog.title + ' (' + (blog.posts | string) + ' post' + ('s' if blog.posts > 1 else '') + ')' if blog.posts else '',
              'selected': request.path == blog.url
            }) %}
          {% endfor %}
          {{ tnaQuickFilters({
            'items': blogs_list,
            'fill': True,
            'stack': True,
            'classes': 'tna-!--margin-top-s'
          }) }}
          {%- endif %}

          {%- if date_filters %}
          <h2 class="tna-heading-m">Filter posts by date</h2>
          {{ tnaQuickFilters({
            'items': date_filters,
            'fill': True,
            'stack': True,
            'classes': 'tna-!--margin-top-s'
          }) }}
          {%- endif %}
          
          {%- if categories %}
          <h2 class="tna-heading-m">Filter posts by category</h2>
          {% set categories_list = [] %}
          {% for category in categories %}
            {% set categories_list = categories_list.append({
              'label': category.title,
              'href': category.full_url,
              'selected': request.path == category.url
            }) %}
          {% endfor %}
          {{ tnaQuickFilters({
            'items': categories_list,
            'fill': True,
            'stack': True,
            'classes': 'tna-!--margin-top-s'
          }) }}
          {%- endif %}
        </div>
      </div>
    </div>
    {%- if authors %}
    <div class="tna-background-tint tna-!--margin-top-l tna-section">
      <div class="tna-container">
        <div class="etna-author-list etna-author-list--horizontal tna-column tna-column--full">
          <h2 class="etna-author-list__heading tna-heading-l">Authors</h2>
          <ul class="etna-author-list__items tna-!--margin-top-s">
            {%- for author in authors[:12] %}
            <li class="etna-author-list__item" itemscope itemtype="https://schema.org/Person">
              {%- if author.author.image_small %}
              <img src="{{ author.author.image_small.jpeg.full_url }}" alt="Profile photo for {{ author.author.title }}" width="{{ author.author.image_small.jpeg.width }}" height="{{ author.author.image_small.jpeg.height }}" class="etna-author-list__image" itemprop="image">
              {%- else %}
              <img src="{{ url_for('static', filename='images/blank-profile.svg') }}" width="128" height="128" class="etna-author-list__image" alt="">
              {%- endif %}
              <div class="etna-author-list__details">
                <p class="etna-author-list__name">
                  <strong>
                    <link itemprop="url" href="{{ author.author.full_url }}">
                    <meta itemprop="jobTitle" content="{{ author.author.role }}">
                    <a href="{{ url_for('wagtail.page', path=author.author.url.strip('/'), page=1) }}" rel="author">
                      <span class="tna-visually-hidden">View all articles by</span>
                      <span itemprop="name">{{ author.author.title }}</span>
                    </a>
                  </strong>
                </p>
                <p class="etna-author-list__description">{{ author.posts }} blog post{{ 's' if author.posts > 1 else '' }}</p>
              </div>
            </li>
            {%- endfor %}
          </ul>
        </div>
      </div>
    </div>
    {%- endif %}
    <div class="tna-container">
      {%- if blogs and page_data.meta.type == 'blog.BlogPage' %}
      <div class="tna-column tna-column--width-2-3 tna-column--width-5-6-medium tna-column--full-small tna-column--full-tiny etna-!--full-width-on-print tna-!--margin-top-l">
        <h2 class="tna-heading-l">Other blogs at The National Archives</h2>
        {%- for blog in blogs %}
        {%- if blog.id != page_data.id %}
          {{ wagtailFeaturedPage({'page': blog}, 3, loop.first) }}
        {%- endif %}
        {%- endfor %}
      </div>
      {%- endif %}
      <div class="tna-column tna-column--full tna-!--hide-on-print">
        <hr class="tna-!--margin-top-l">
        <div class="tna-button-group tna-!--margin-top-s">
          {{ tnaButton({
            'text': 'Back to top',
            'href': '#top',
            'icon': 'arrow-up',
            'small': True,
            'plain': True
          }) }}
        </div>
      </div>
    </div>
  </main>
{% endblock %}
